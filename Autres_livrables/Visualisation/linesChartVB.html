<!DOCTYPE html>
<html>
<head>
  <title>Lines Chart</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://d3js.org/d3-color.v2.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>


  <script src="https://d3js.org/d3.v6.js"></script>
<style>

  div.tooltip {
    position: absolute;
    text-align: center;
    color: black;
    padding:4px;
    width: 90px;
    height: 77px;
    font: 15px sans-serif;
    pointer-events: none;
}

.svg-container{
  width:100%;
  overflow: hidden;
}

.svg-content {
    display: inline-block;
    position: absolute;
    top: 100px;
    left: 0;
}

svg{
  max-width: 100%;
}

</style>
</head>
<body>


<div id="cadre_opacity">
    <label for="opacity" 
         style="display: inline-block; width: 240px; height: 50px; padding : 50px;text-align: right">
         Opacity =</label>
  <input type="range" min="0" max="100" value="100" id="opacity">
  
</div>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz" class="svg-container row">

</div>

<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div><div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
<div class="row m-5"><br>a</div>
>
<div class="row">a</div>

<script>
// set the dimensions and margins of the graph
var margin = {top: 100, right: 100, bottom: 100, left: 100},
    width = 1400 - margin.left - margin.right,
    height = 800 - margin.top - margin.bottom;

var widthrect=200
// append the svg object to the body of the page




var dy=0
var dx=1.6*dy

var svg = d3.select("#my_dataviz")
  .append("svg")
  .attr("preserveAspectRatio", "xMinYMin meet")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)

  .attr("viewBox", 0 +" "+ -dy +" "+(width+margin.left+margin.right)+" "+ (height+margin.top+margin.bottom))
  .classed("svg-content", true)

  .append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")")

// var svg = d3.select("#my_dataviz")
//   .append("svg")
//     .attr("width", width + margin.left + margin.right)
//     .attr("height", height + margin.top + margin.bottom)
//     .append("g")
//     .attr("transform",
//           "translate(" + margin.left + "," + margin.top + ")")

      // .call(d3.zoom().on("zoom", function () { 
      //      svg.attr("transform", d3.event.transform) 
      // })) 


svg.append("rect")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .attr("fill","white")
    .attr("stroke-width",1)
    .attr("stroke","black")
    .attr("x",-margin.left).attr("y",-margin.top)


 
d3.select("svg").transition().duration(400).attr("opacity",1);
console.log(window.scrollY)
// Visibility set to "block" when scrolling
 
window.addEventListener("scroll", function(){
 
  if(window.scrollY > 350){
 
    d3.select("svg").transition().duration(200).attr("opacity",0);
  }
  else{
 
    d3.select("svg").transition().duration(200).attr("opacity",1);
  }
}, false);

//Read the data

var data=[{year:2010, value:Math.random()*10},{year:2011, value:Math.random()*10},{year:2012, value:Math.random()*10},{year:2013, value:Math.random()*10},{year:2014, value:Math.random()*10},{year:2015, value:Math.random()*10},{year:2016, value:Math.random()*10},{year:2017, value:Math.random()*10},{year:2018, value:Math.random()*10},{year:2019, value:Math.random()*10},{year:2020, value:Math.random()*10},{year:2021, value:Math.random()*10}]

var data2=[{year:2010, value:Math.random()*10},{year:2011, value:Math.random()*10},{year:2012, value:Math.random()*10},{year:2013, value:Math.random()*10},{year:2014, value:Math.random()*10},{year:2015, value:Math.random()*10},{year:2016, value:Math.random()*10},{year:2017, value:Math.random()*10},{year:2018, value:Math.random()*10},{year:2019, value:Math.random()*10},{year:2020, value:Math.random()*10},{year:2021, value:Math.random()*10}]

var data3=[{year:2010, value:Math.random()*10},{year:2011, value:Math.random()*10},{year:2012, value:Math.random()*10},{year:2013, value:Math.random()*10},{year:2014, value:Math.random()*10},{year:2015, value:Math.random()*10},{year:2016, value:Math.random()*10},{year:2017, value:Math.random()*10},{year:2018, value:Math.random()*10},{year:2019, value:Math.random()*10},{year:2020, value:Math.random()*10},{year:2021, value:Math.random()*10}]

var data4=[{year:2010, value:Math.random()*10},{year:2011, value:Math.random()*10},{year:2012, value:Math.random()*10},{year:2013, value:Math.random()*10},{year:2014, value:Math.random()*10},{year:2015, value:Math.random()*10},{year:2016, value:Math.random()*10},{year:2017, value:Math.random()*10},{year:2018, value:Math.random()*10},{year:2019, value:Math.random()*10},{year:2020, value:Math.random()*10},{year:2021, value:Math.random()*10}]


datamoy=[]

datas=[data, data2, data3, data4]

for(let j=0; j<data.length; j++){
  var sum=0
  for (let i=0; i<datas.length; i++){
     sum+=datas[i][j].value
  }

       datamoy.push({year : data[j].year, value: sum/datas.length})
}
datas.push(datamoy)


var domain=d3.extent(data, function(d){return d.year})
domain[0]-=0.5
domain[1]+=0.5


clicked=[]
count=datas.length

//try missing values chart
for(let i=0; i<datas.length; i++){

datas[i].unshift({year:domain[0], value:(datas[i][0].value+5)/2})
datas[i].unshift({year:domain[0], value:0})
datas[i].push({year:domain[1], value:(datas[i][datas[i].length-1].value+5)/2})
datas[i].push({year:domain[1], value:0})

}

var X= d3.scaleLinear()
      .domain(domain)
      .range([0, width])

var xaxis=svg.append("g")
  .attr("transform", "translate(0," + height + ")")
  .call(d3.axisBottom(X).ticks(10))


var Y = d3.scaleLinear()
  .domain([0, 3+d3.max(data, function(d) { return d.value; })])
  .range([ height, 0 ]);

var yaxis=svg.append("g")
  .call(d3.axisLeft(Y));



var color=["steelblue","red","green","black","grey"]
var colorused=[]


for(let i=0;i<datas.length; i++){
  colorused[i]=color[i]
}

for(let i=0; i<datas.length; i++){
  clicked[colorused[i]]=1
}

line0=d3.line()
        .x(function(d) {return X(d.year)})
        .y(function(d) { return Y(0)})

line=d3.line()
        .defined(d => !isNaN(d.value))
        .x(function(d) { return X(d.year) })
        .y(function(d) { return Y(d.value) })



for(let k=0; k<datas.length; k++){

svg.append("path").attr("id",color[k])
     .datum(datas[k])
     .attr("fill", colorused[k])
     .attr("fill-opacity", 1*datas.length)
     .attr("stroke", "steelblue")
     .attr("stroke-width", 1.5)
     .attr("stroke-linejoin", "round")
     .attr("stroke-linecap", "round")
     .attr("stroke", color[k])
     .attr("stroke-width", .7)

     .on("mouseover",function(){
        d3.select("svg").selectAll("path").attr("fill-opacity",0.01).attr("stroke-opacity",0.2)
        d3.select("svg").selectAll("g").selectAll("circle").attr("opacity",0.2)
        d3.select(this).attr("fill-opacity",0.7)
        d3.select("g#legendes"+color[k]).selectAll("text").attr("opacity",1)})
     

     .on("mouseout",function(){
      d3.select("g#legendes"+color[k]).selectAll("text").attr("opacity",0)
              d3.select("svg").selectAll("g").selectAll("circle").attr("opacity",0.5)
      updateOpacity(50)})


     .attr("d", line0)
     .transition().delay(400*k).duration(800)
     .attr("d", line)



 svg.append("g").attr("id","circle"+ color[k]).selectAll("circle")
  .data(datas[k])
  .enter()
  .append("circle")
      .attr("cx", function(d){return X(d.year)})
    .attr("cy",function(d){return Y(0)})
    .transition().delay(400*k).duration(500)
    .attr("cx", function(d){return X(d.year)})
    .attr("cy",function(d){return Y(d.value)})
    .attr("r",2.5)
    .attr("fill",colorused[k])
    .style("stroke", "gray")


}

for(let k=0; k<datas.length; k++){
    svg.append("g").attr("id", "legendes"+color[k]).selectAll("text").data(datas[k]).enter()
    .append("text")
    .text(function(d,i){
      if(d.year%1==0){return d.value.toPrecision(2)} else {return ""}})
    .attr("x", function(d){return X(d.year)})
    .attr("y", function(d){return Y(d.value)-40})
    .attr("font-size", 20)
    .attr("text-anchor","middle")
    .attr("opacity",0)
}

div=d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0 )
    .style("width",2*X(2010))
    .style("background"," #283747")
    .style("color", "white")
    .style("top", (margin.top)+"px")


// for(let k=0; k<datas.length; k++){
  
//    svg.append("g").selectAll("rect")
//     .data(datas[k])
//     .enter()
//     .append("rect")
//     .attr("id",function(d){return d.year})
//     .attr("x", function(d,i){return X(d.year-0.5)})
//     .attr("y", 0)
//     .attr("width", function(d,i){if(i==0||i==1||i==datas[k].length-1||i==datas[k].length-2){return 0;} else return 2*X(2010)})
//     .attr("height", height)
//     .attr("stroke-width",0)
//     .attr("fill","#A2D9CE")
//     .attr("fill-opacity",0)
//     .attr("stroke-width",0.5)
//     .attr("stroke-opacity",0)
//     .on("mouseover",function(d,i){
//           if(count==1){
//             d3.select(this).attr("stroke-opacity",0.4)
//                     .attr("fill-opacity",0.6)

//             div.style("opacity", 1)
//             div.html("En " +i.year +" : <br><br>"+ i.value.toPrecision(2))  
//                   .style("left", X(i.year)+15+"px") 
//                 }
//       } )   



//       .on("mouseout",function(d,i){
//             d3.select(this).attr("fill-opacity",0).attr("stroke-opacity",0)
//             div.style("opacity",0)})
// }



  svg.append("g").selectAll("rect").data(colorused).enter().append("rect")
      .attr("x", width+margin.right/4)
      .attr("y", function(d,i){return i*40})
      .attr("width",20)
      .attr("height", 20)
      .attr("stroke",function(d){return d})
      .attr("fill",function(d){return d})
      .on("click", function(d,i){
        if(clicked[i]==1){
                  d3.select("path#"+ i).transition().duration(800).attr("d", d3.line()
                  .x(function(d) { return X(d.year)})
                  .y(function(d) { return Y(0)}))
                  d3.selectAll("g").select("#circle"+i).selectAll("circle").transition().duration(1000).attr("cy", Y(0)).attr("opacity",0)
                  d3.select(this).attr("fill","white")
                  clicked[i]=0
                  count-=1
                }
        else{        
          d3.select(this).attr("fill",function(d,i){return d})
          d3.select("path#"+ i).transition().duration(1000)
          .attr("d", d3.line()
        .x(function(d) {return X(d.year)})
        .y(function(d) {return Y(d.value)}))
                  d3.selectAll("g").select("#circle"+i).selectAll("circle").transition().duration(800).attr("cy", function(d){return Y(d.value)}).attr("opacity",1)
          clicked[i]=1
          count+=1
        }})


d3.select("svg").append("text").text("Titre du graphique").attr("x", width/2-80).attr("y",0.12 *height).attr("text-anchor","start").attr("font-size","50px")

  svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 20 - margin.left)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .attr("font-size","25px")
      .text("Value");

  svg.append("text")
      .attr("y", height +30)
      .attr("x", width/2)
      .attr("dy", "1em")
      .style("text-anchor", "middle")
            .attr("font-size","25px")
      .text("Year");




d3.select("#opacity").on("input", function() {
  updateOpacity(this.value);
});

function updateOpacity(opacity){
  d3.selectAll("path").attr("fill-opacity", opacity/100)
}


var zoom = d3.zoom()  
  .scaleExtent([1, 10]) 
  .translateExtent([[0, 0], [width, height]]) 
  .on("zoom", zoom); 
   
// Call the Zoom. 
svg.call(zoom); 

  /*svg.append("g").attr("id","circle").selectAll("circle").data(color).enter().append("circle").attr("id",function(d){return d})
      .attr("cx", function(d,i){return 120*i})
      .attr("cy",0)
      .attr("r",50)
      .attr("fill", function(d){return d})
      .style("stroke", "gray")

  svg.append("g").append("rect")
      .attr("x", 800)
      .attr("y", 0)
      .attr("width",100)
      .attr("height", 100)
      .attr("stroke-width",0)
      .attr("fill","black")
      .on("click", function(d){d3.select("g#circle").selectAll("circle").attr("r",function(d,i){
        console.log(i); console.log(d);return 5*d.length})})*/











        //ZOOOM ET FONCTION.PROPERTY GIT MERGE
  </script>
</body>
</html>


