<!DOCTYPE html>
<html>
<head>
	<title>Carte chloroplete</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://d3js.org/d3-color.v2.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>


	<script src="https://d3js.org/d3.v5.js"></script>
<style>

  div.tooltip {
    position: absolute;
    text-align: center;
    color: black;
    width: 190px;
    height: 45px;
    padding: 4px;
    font: 15px sans-serif;
    background: #dddddd;
    border-radius: 8px;
    pointer-events: none;
}

  div.pres {
    position: absolute;
    text-align: right;
    width: 370px;
    height: 330px;
    padding: 20px;
    font: 15px sans-serif;
    background: #eeeeee;
    border: 10px;
    stroke-width: 3px;
    pointer-events: none;
}

  svg {

    padding: 20px;
    font: 15px sans-serif;
    background: #7FB3D5 ;
    border: 100px;
    stroke-width: 3px;

}

</style>
</head>
<body>

	<h1 class="mt-5 mb-3 text-center">Carte dataviz</h1>

<script type="text/javascript">


const width= 1400;
const height =700;
var k=2;
var f=1
var first=1
var clicked=0
const countries=["La Reunion", "Mauritius", "Seychelles", "Madagascar", "Comoros", "Mozambique"]

const countries_dic={}

//Référence aux cartodb
countries_dic["Comoros"]=11;
countries_dic["Mauritius"]=34;
countries_dic["Madagascar"]=30;
countries_dic["Mozambique"]=37;
countries_dic["La Réunion"]=42;
countries_dic["Seychelles"]=46;
 
//Les ensembles représentent 0 : les exploitations familiales, 1 : les exp total, 2 : les performances de l'exploitation, 

exploitations_familiales_dic={}
exploitations_familiales_dic[11]=[1278,2465,Math.round(100*Math.random())]
exploitations_familiales_dic[30]=[21964,64877,Math.round(100*Math.random())]
exploitations_familiales_dic[34]=[238,726,Math.round(100*Math.random())]
exploitations_familiales_dic[37]=[7741,13678,Math.round(100*Math.random())]
exploitations_familiales_dic[42]=[459,875,Math.round(100*Math.random())]
exploitations_familiales_dic[46]=[221,128,Math.round(100*Math.random())]


const path=d3.geoPath();



const projection = d3.geoMercator()
	.center([63.0, -20.5])
	.scale(1200)
	.translate([width/2, height/2]);

path.projection(projection);


//Création du svg
const svg = d3.select("body")
	.append("svg")
	.attr("id","mapid")
  .attr("transform", "translate("+width/6 +",50)")
	.attr("width", width)
	.attr("height",height);

//Création du tooltip
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

//Création de la zone d'informations
var pres=d3.select("body").append("div")
        .attr("class","pres")
        .style("opacity","0")
        .style("left", "1250px")     
        .style("top", 162 + "px")

var mincartodb=11;
var maxcartodb=48;
var min_exp_oa=0
var max_exp_oa=1000;
var min_exp_f=100;
var max_exp_f=500;
var min_exp=500;
var max_exp=5000;
var sizeleg=12;


var scaleSelection=["exp_oa", "exp_f","exp"]

var selected=scaleSelection[1]
var selectedbefore
var colorScale;
var delta;



function update(){
if(!colorScale){
	colorScaleBefore=d3.scaleSequential(d3.interpolate("grey", "grey")).domain([100, 1000]);
}else{ colorScaleBefore=colorScale}


switch(selected){
	case "exp_oa": colorScale= d3.scaleSequential(d3.interpolate("white", "blue")).domain([min_exp_oa, max_exp_oa]);
	delta=max_exp_oa-min_exp_oa
	min=min_exp_oa
	max=max_exp_oa
	break;

	case "exp_f" : colorScale=d3.scaleSequential(d3.interpolate("green", "red ")).domain([min_exp_f, max_exp_f]);
		delta=max_exp_f-min_exp_f
		min=min_exp_f
		max=max_exp_f
	break;

	case "exp" : colorScale=d3.scaleSequential(d3.interpolate("#A04000", "#F7DC6F")).domain([min_exp, max_exp]);
		delta=max_exp-min_exp
		min=min_exp
		max=max_exp
	break;
	default: alert("erreur")

} 

}

function coloration(d){
	 if(!countries.includes(d.properties.name)){return "grey"}
      else if(selected=="exp_oa"){return colorScale(d.properties.exp_oa)}
      else if(selected=="exp_f"){return colorScale(d.properties.exp_f)} 
      else if(selected=="exp"){return colorScale(d.properties.exp)}
      	else{return "green"}


}


function colorationb(d){
	 if(!countries.includes(d.properties.name)){return "grey"}
      else if(selectedbefore=="exp_oa"){return colorScaleBefore(d.properties.exp_oa)}
      else if(selectedbefore=="exp_f"){return colorScaleBefore(d.properties.exp_f)} 
      else if(selectedbefore=="exp"){return colorScaleBefore(d.properties.exp)}
      	else{return "grey"}


}


update()
creation()

function scaler(d){
	const [[x0, y0], [x1, y1]] = path.bounds(d);
	f=1
	if((x1-x0)*(y1-y0)<200){
		f=4
		if(d.properties.name=="Mauritius"){
			return "translate("+ (-0.82*x0*f+120) +","+ -0.72*f*y0 +")scale("+f+")"
		}
		else return "translate("+ (-0.82*x0*f+80) +","+ -0.72*f*y0 +")scale("+f+")"
	}
	else return "scale(1)"
	
}


function legend(){  //légende 
var legend = svg.append('g').attr("class","shiftable")
    .attr('id', 'legend');

    legend.selectAll('.colorbar')
    .data(d3.range(35))
    .enter().append('svg:rect')
        .attr('y', 8.5*height/10 + 'px')
        .attr('height', '20px')
        .attr('width', sizeleg+1 +'px')
        .attr('x', function(d,i){return 19*width/20-i*sizeleg +"px"})
        .attr('fill', function(d,i){ return colorScale(max-i*delta/35)})



var legendScale = d3.scaleLinear()
    .domain([min, max])
    .range([0, (35)*sizeleg]);



 var legendAxis = svg.append("g").attr("class","shiftable").attr('id', 'legend')
    .attr('transform', 'translate('+ (19*width/20-(35-1)*sizeleg) +','+ 9*height/10 +')')
    .call(d3.axisBottom(legendScale).ticks(6));
}





function dataChoice(states){
	var scaleSelect=svg.append("g").selectAll("rect")
	.data(scaleSelection).enter()
		.append("rect")
		.attr("class","dataChoice")
		.attr("id", function(d){return d})
		.attr("stroke","black")
		.attr("fill",function(d,i){if(selected==scaleSelection[i]){return "black";}
			else {return "white";}})
		.attr("x",0.85*width-40)
		.attr("y",function(d,i){return 0.65*height+50*i-15})
		.attr("height","20")
		.attr("width","20")
				.on("click", function(d,i){

					if(selected!=scaleSelection[i]){
						selectedbefore=selected
						selected=scaleSelection[i];
						update()
						d3.select("svg").selectAll("g#legend").remove()
						if(clicked!=0){
							d3.select("svg").selectAll("g#states").selectAll("path").attr("opacity", 1).transition('s').duration(1000).attr("opacity", 0)
							pres.transition('z').duration(50).style("opacity",0);
						}
						d3.select("svg").selectAll("g#states").selectAll("path").transition('y').duration(800).remove()
						d3.select("svg").selectAll("g.shiftable").transition().duration(800)
						.remove()
						pres.transition('z').duration(50)
					        .style("opacity",0);
						creation(d)
						clicked=0

					}}
					)

//Légendes des données à colorer

if (first==1){
	var scaleSelect=svg.select("g").attr("class","dataChoice").selectAll("text")
		.data(scaleSelection).enter()
			.append("text")
			.text(function(d){if(d=="exp_oa")return "Exploitations observees";
				if(d=="exp_f")return "Exploitations familiales"
				if(d=="exp")return "Exploitations"})
			.attr("fill","white")
			.attr("x",8.5*width/10)
			.attr("y",function(d,i){return 0.65*height+50*i})


	svg.append("g").attr("class","dataChoice")
			.append("text")
			.text("Colorer par :")
			.attr("fill","white")
			.attr("font-size","20px")
			.attr("x",8.5*width/10-15)
			.attr("y",0.65*height-50)

	first=0
	}
}



//Création des frontières.

function creation(){

	const states = svg.append("g").attr("class","shiftable").attr("id","states")
  		.attr("d", path);


dataChoice()
//choix des données à colorer
// if(first==1){
// 	dataChoice(states)
// 	first=0
// }
	legend()

	var state=d3.json("africa.geojson").then(function(geojson){
		states.selectAll("path")
		.data(geojson.features)
		.enter()
		.append("path")
		.attr("d",path)
		.attr("id",function(d){d.properties.name})
	  	.attr("stroke","white")
	  	.attr("fill", function(d){return colorationb(d)})
	 	.attr("transform", function(d){ 
		let s=scaler(d);
			if(f==4){
				d3.select(this).attr("stroke-width","0.8px")
			}  		
			if(f==1)
			{
				d3.select(this).attr("stroke-width","2.5px")
			}
			return s
			}
		)

	//Affichage du tooltip
	  .on("mouseover", function(d){
	    if (clicked!=d.properties.name){
	      d3.event.stopPropagation;
	      d3.select(this).transition("c")
	            .attr("stroke","yellow")
	            // .attr("stroke-width",function(d){if (clicked!=0){return "0.8px"} 
	            // 	else {return "3px"}});
                div.transition()        
                .duration(200)
                .style("opacity", 1)

	            div.html("Pays : " + d.properties.name + "<br/>"
	                  +  "Exploitations : " + d.properties.exp)  
	                .style("left", (d3.mouse(this)[0] +300 + "px")) 
	                .style("top", (d3.mouse(this)[1] +160+ "px"))
	               }})


	//Réinitialisation
	    .on("mouseout", function(d){
	      d3.select(this).transition("d")
	        .attr("stroke","white")
	        .attr("stroke-width", function(d){
	        const [[x0, y0], [x1, y1]] = path.bounds(d);
			if((x1-x0)*(y1-y0)<20000){
				return "0.8px"
	 		}  		
	 		else{return "2.5px"}
	 	}
	 			)

	      div.style("opacity", 0)})
	  	.on("click", clicked2)
	  	.transition().duration(1000)
	 	.attr("fill", function(d){return coloration(d)})

});

}



function clicked2(d){

//Si le pays ne fait pas partie de la COI on affiche un message d'erreur
  if(!countries.includes(d.properties.name)){
    console.log("raté")
    alert("Ce pays ne fait pas partie de la COI")
  }

//Si il fait partie de la coi et rien n'est cliqué on zoom et on affiche des informations
  else if (clicked==0){
    const [[x0, y0], [x1, y1]] = path.bounds(d);
    k= (800/((y1-y0)+(x1-x0)))
    clicked=d.properties.name;
    d3.select(this)
        .transition("z")
        .ease(d3.easeBack)
        .duration(1750)
        .attr("transform","translate("+ -((k-0.8)*x0-(0.4*width-x0)-75) +","+ -((k*y0)-100) +")scale("+ k +")")
        .attr("stroke-width", function(d){
        	if((x1-x0)*(y1-y0)<200)
        	{
			return "0.5px"
		}
 		else{
 			return "2.5px"
 		}
 			});
    pres.transition("z")
        .duration(1750)
        .style("opacity",1);
        pres.html("<h1>"+ d.properties.name +"</h1><br><h4> Exploitations familiales : " +d.properties.exp_f +"<br><br>"
          + "Exploitations : " + d.properties.exp +"<br><br>"
          + "Performance globale : " + exploitations_familiales_dic[d.properties.cartodb_id][2] +"</h4><br><a href=#> Voir plus en details</a>")

  }

//Si on clique sur l'objet zoomé, on dézoome
   else if(clicked==d.properties.name){
   	    clicked=0;
    d3.select(this)
        .transition("z")
        .ease(d3.easeBounce)
        .duration(1500)
        //.attr("stroke_width", "2.5px")
        .attr("transform","translate(0,0)scale(1)")
        .attr("transform", function(d){let s=scaler(d);
 		if(f==4){
 			d3.select(this).attr("stroke-width","0.8px")
 		}  		
 		if(f==1)
 			{
 			d3.select(this).attr("stroke-width","2.5px")
 			}
 			return s 	
 		})
        
        pres.transition("z")
        .duration(1500)
        .style("opacity",0);
  }

  else{
    return ;
  }

 
}



</script>



<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

</body>
</html>