<!DOCTYPE html>
<html>
<head>
	<title>Carte chloroplete</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

    <script src="https://d3js.org/d3-color.v2.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v2.min.js"></script>


	<script src="https://d3js.org/d3.v5.js"></script>
<style>

  div.tooltip {
    position: absolute;
    text-align: center;
    color: black;
    width: 275px;
    height: 37px;
    padding: 2px;
    font: 12px sans-serif;
    background: #aaaaaa;
    border: 10px;
    border-radius: 8px;
    pointer-events: none;
}

  div.pres {
    position: absolute;
    text-align: right;
    width: 370px;
    height: 330px;
    padding: 20px;
    font: 15px sans-serif;
    background: #eeeeee;
    border: 10px;
    stroke-width: 3px;
    pointer-events: none;
}

  svg {

    padding: 20px;
    font: 15px sans-serif;
    background: #48707B;
    border: 100px;
    stroke-width: 3px;

}

</style>
</head>
<body>

	<h1 class="mt-5 mb-3 text-center">Carte dataviz</h1>

<script type="text/javascript">


const width= 1400;
const height =700;
var k=2;

var clicked=0
const countries=["La Reunion", "Mauritius", "Seychelles", "Madagascar", "Comoros", "Mozambique"]

const countries_dic={}

//Référence aux cartodb
countries_dic["Comoros"]=11;
countries_dic["Mauritius"]=34;
countries_dic["Madagascar"]=30;
countries_dic["Mozambique"]=37;
countries_dic["La Réunion"]=42;
countries_dic["Seychelles"]=46;
 
//Les ensembles représentent 0 : les exploitations familiales, 1 : les exp total, 2 : les performances de l'exploitation, 

exploitations_familiales_dic={}
exploitations_familiales_dic[11]=[1278,2465,Math.round(100*Math.random())]
exploitations_familiales_dic[30]=[21964,64877,Math.round(100*Math.random())]
exploitations_familiales_dic[34]=[238,726,Math.round(100*Math.random())]
exploitations_familiales_dic[37]=[7741,13678,Math.round(100*Math.random())]
exploitations_familiales_dic[42]=[459,875,Math.round(100*Math.random())]
exploitations_familiales_dic[46]=[221,128,Math.round(100*Math.random())]



const path=d3.geoPath();



const projection = d3.geoMercator()
	.center([63.0, -20])
	.scale(1200)
	.translate([width/2, height/2]);

path.projection(projection);


//Création du svg
const svg = d3.select("body")
	.append("svg")
	.attr("id","mapid")
  .attr("transform", "translate("+width/6 +",50)")
	.attr("width", width)
	.attr("height",height);

//Création du tooltip
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

//Création de la zone d'informations
var pres=d3.select("body").append("div")
        .attr("class","pres")
        .style("opacity","0")
        .style("left", "1250px")     
        .style("top", 162 + "px")

var mincartodb=11;
var maxcartodb=48;
var sizeleg=12;
var colorScale = d3.scaleSequential(d3.interpolate("yellow", "red")).domain([mincartodb, maxcartodb]);
//.attr("fill", (d) => colorScale(d.propertie.value)) ;

//Création du path
const states = svg.append("g")
  //.attr("fill","#787A21")
  .attr("d", path);

  //légende 
var legend = svg.append('g')
    .attr('id', 'legend');

    legend.selectAll('.colorbar')
    .data(d3.range(maxcartodb-mincartodb))
    .enter().append('svg:rect')
        .attr('y', 8.5*height/10 + 'px')
        .attr('height', '20px')
        .attr('width', sizeleg+1 +'px')
        .attr('x', function(d,i){return 19*width/20-i*sizeleg +"px"})
        .attr('fill', function(d,i){ return colorScale(20+i)})


var legendScale = d3.scaleLinear()
    .domain([mincartodb, maxcartodb])
    .range([0, (maxcartodb-mincartodb)*sizeleg]);

    var legendAxis = svg.append("g")
    .attr('transform', 'translate('+ (19*width/20-(maxcartodb-mincartodb-1)*sizeleg) +','+ 9*height/10 +')')
    .call(d3.axisBottom(legendScale).ticks(6));

//Création des frontières.
var state=d3.json("africa.geojson").then(function(geojson){
	states.selectAll("path")
	.data(geojson.features)
	.enter()
	.append("path")
	.attr("d",path)
  .attr("stroke","white")
  .attr("stroke-width","2.5px")
  //chloroplète
  .attr("fill", function(d) { 
    if(!countries.includes(d.properties.name)){return "grey"}
      else{return colorScale(d.properties.cartodb_id)}}) 


//Affichage du tooltip
  .on("mouseover", function(d){
    if (clicked!=d.properties.name){
      d3.event.stopPropagation;
      d3.select(this).transition("c")
            .attr("stroke","yellow")
            .attr("stroke-width","3px");
                div.transition()        
                .duration(200)
                .style("opacity", 1)

            div.html("Pays : " + d.properties.name + "<br/>"
                  +  "Mis a jour le : " + d.properties.updated_at)  
                .style("left", (d3.mouse(this)[0] +300 + "px")) 
                .style("top", (d3.mouse(this)[1] +160+ "px"))
               }})


//Réinitialisation
    .on("mouseout", function(d){
      d3.select(this).transition("d")
        .attr("stroke","white")
        .attr("stroke-width","1.5px");
      div.style("opacity", 0)})
  .on("click", clicked2)

});



function clicked2(d){

//Si le pays ne fait pas partie de la COI on affiche un message d'erreur
  if(!countries.includes(d.properties.name)){
    console.log("raté")
    alert("Ce pays ne fait pas partie de la COI")
  }

//Si il fait partie de la coi et rien n'est cliqué on zoom et on affiche des informations
  else if (clicked==0){
    const [[x0, y0], [x1, y1]] = path.bounds(d);
    k= (800/((y1-y0)+(x1-x0)))
    console.log(k)
    d3.select(this)
        .transition("z")
        .ease(d3.easeBack)
        .duration(1750)
        .attr("transform","translate("+ -((k-0.8)*x0-(0.4*width-x0)-75) +","+ -((k*y0)-100) +")scale("+ k +")")
        .attr("fill", "#FDE7D6");

    pres.transition("z")
        .duration(1750)
        .style("opacity",1);
        pres.html("<h1>"+ d.properties.name +"</h1><br><h4> Exploitations familiales : " + exploitations_familiales_dic[d.properties.cartodb_id][0] +"<br><br>"
          + "Exploitations : " + exploitations_familiales_dic[d.properties.cartodb_id][1] +"<br><br>"
          + "Performance globale : " + exploitations_familiales_dic[d.properties.cartodb_id][2] +"</h4><br><a href=#> Voir plus en details</a>")

        clicked=d.properties.name;
  }

//Si on clique sur l'objet zoomé, on dézoome
   else if(clicked==d.properties.name){
    d3.select(this)
        .transition("z")
        .ease(d3.easeBounce)
        .duration(1500)
        .attr("transform","translate(0,0)scale(1)")
         .attr("fill", (d) => colorScale(d.properties.cartodb_id)) 
        pres.transition("z")
        .duration(1500)
        .style("opacity",0);
    clicked=0;
  }

  else{
    return ;
  }

 
}



</script>



<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

</body>
</html>